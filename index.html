<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Map Album - æ€ã„å‡ºã‚’åœ°å›³ã«</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js" onerror="console.warn('heic2any library failed to load. HEIC support will be disabled.')"></script>
    
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6725771070196390"
         crossorigin="anonymous"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --black: #000000;
            --white: #ffffff;
            --gray-light: #f5f5f5;
            --gray-mid: #cccccc;
            --gray-dark: #333333;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            background: var(--white);
            color: var(--black);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--black);
            color: var(--white);
            padding: 1rem;
            padding-top: calc(1rem + env(safe-area-inset-top));
            padding-left: max(1rem, env(safe-area-inset-left));
            padding-right: max(1rem, env(safe-area-inset-right));
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-btn {
            background: none;
            border: 2px solid var(--white);
            color: var(--white);
            font-size: 1.2rem;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-btn:hover {
            background: var(--white);
            color: var(--black);
            transform: rotate(90deg);
        }

        .header h1 {
            font-size: 1.2rem;
            font-weight: 700;
            letter-spacing: 0.05em;
        }

        .header-subtitle {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 0.25rem;
            letter-spacing: 0.1em;
        }

        /* Main Container */
        .container {
            padding-top: calc(5.5rem + env(safe-area-inset-top));
            padding-bottom: calc(5rem + env(safe-area-inset-bottom));
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            min-height: 100vh;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            border-bottom: 2px solid var(--black);
            position: sticky;
            top: calc(4.5rem + env(safe-area-inset-top));
            background: var(--white);
            z-index: 100;
        }

        .tab-button {
            flex: 1;
            padding: 1rem;
            background: none;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-button.active {
            background: var(--black);
            color: var(--white);
        }

        .tab-button:not(.active):hover {
            background: var(--gray-light);
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Memo List */
        .memo-list {
            padding: 1rem;
        }

        .memo-card {
            background: var(--white);
            border: 2px solid var(--black);
            margin-bottom: 1rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .memo-card:hover {
            transform: translateX(5px);
            box-shadow: -5px 5px 0 var(--black);
        }

        .memo-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.5rem;
        }

        .memo-location {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
        }

        .memo-date {
            font-size: 0.85rem;
            color: var(--gray-dark);
            opacity: 0.7;
        }

        .memo-preview {
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 0.75rem;
            color: var(--gray-dark);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .memo-photo-count {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--black);
            color: var(--white);
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            margin-top: 0.5rem;
        }

        .memo-thumbnails {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 0.5rem;
            margin-top: 0.75rem;
            max-width: 100%;
        }

        .memo-thumbnail {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border: 2px solid var(--black);
            transition: all 0.3s ease;
        }

        .memo-thumbnail:hover {
            transform: scale(1.05);
            z-index: 1;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--gray-dark);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .empty-state-text {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .empty-state-subtext {
            font-size: 0.9rem;
            opacity: 0.7;
        }

        /* Map */
        .map-container {
            position: relative;
            height: calc(100vh - 8rem - env(safe-area-inset-top) - env(safe-area-inset-bottom));
            margin: 1rem;
            border: 2px solid var(--black);
        }

        #viewMap {
            height: 100%;
            width: 100%;
            background: var(--gray-light);
        }

        /* FAB */
        .fab {
            position: fixed;
            right: max(1.5rem, env(safe-area-inset-right) + 0.5rem);
            bottom: max(1.5rem, env(safe-area-inset-bottom) + 0.5rem);
            width: 60px;
            height: 60px;
            background: var(--black);
            color: var(--white);
            border: none;
            border-radius: 50%;
            font-size: 2rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            z-index: 500;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }

        .fab:active {
            transform: scale(0.95);
        }

        .fab.disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .fab.disabled:hover {
            transform: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .fab-badge {
            position: fixed;
            right: max(1.5rem, env(safe-area-inset-right) + 0.5rem);
            bottom: max(1.5rem, env(safe-area-inset-bottom) + 0.5rem);
            margin-right: -5px;
            margin-bottom: 45px;
            background: #ff0000;
            color: var(--white);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: 700;
            border: 3px solid var(--white);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            z-index: 501;
            pointer-events: none;
        }

        .fab-badge.zero {
            background: #999;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: var(--white);
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            margin: 2rem;
            border: 3px solid var(--black);
            box-shadow: 8px 8px 0 rgba(0,0,0,0.2);
        }

        .modal-header {
            background: var(--black);
            color: var(--white);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1001;
        }

        .modal-header h2 {
            font-size: 1.2rem;
            font-weight: 700;
            letter-spacing: 0.05em;
        }

        .close-btn {
            background: none;
            border: 2px solid var(--white);
            color: var(--white);
            width: 36px;
            height: 36px;
            border-radius: 6px;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .close-btn:hover {
            background: var(--white);
            color: var(--black);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 1.5rem;
        }

        /* Memo Detail Modal */
        .detail-section {
            margin-bottom: 1.5rem;
        }

        .detail-label {
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-size: 0.85rem;
            border-bottom: 2px solid var(--black);
            padding-bottom: 0.25rem;
        }

        .detail-content {
            padding: 0.75rem 0;
            line-height: 1.7;
        }

        .detail-photos {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 0.75rem;
            margin-top: 0.75rem;
        }

        .detail-photo {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border: 2px solid var(--black);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .detail-photo:hover {
            transform: scale(1.05);
            box-shadow: 4px 4px 0 var(--black);
        }

        .btn-delete {
            width: 100%;
            padding: 1rem;
            background: var(--black);
            color: var(--white);
            border: 2px solid var(--black);
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .btn-delete:hover {
            background: var(--gray-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 0 var(--black);
        }

        /* Add Photo Form */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-size: 0.85rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--black);
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            box-shadow: 4px 4px 0 var(--black);
            transform: translate(-2px, -2px);
        }

        textarea.form-input {
            min-height: 120px;
            resize: vertical;
        }

        .map-container-add {
            height: 300px;
            border: 2px solid var(--black);
            margin-bottom: 1rem;
            position: relative;
            z-index: 1;
        }

        #addMap {
            height: 100%;
            width: 100%;
        }

        .map-instructions {
            padding: 0.75rem;
            background: var(--gray-light);
            border: 2px solid var(--black);
            margin-bottom: 1rem;
            font-size: 0.9rem;
            text-align: center;
        }

        .photo-upload-area {
            border: 3px dashed var(--black);
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--gray-light);
        }

        .photo-upload-area:hover {
            background: var(--white);
            border-color: var(--gray-dark);
        }

        .photo-upload-area input {
            display: none;
        }

        .photo-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .photo-preview-item {
            position: relative;
            aspect-ratio: 1;
        }

        .photo-preview-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border: 2px solid var(--black);
        }

        .photo-remove {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--black);
            color: var(--white);
            border: 2px solid var(--white);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .photo-remove:hover {
            transform: scale(1.2);
            background: var(--gray-dark);
        }

        .btn {
            width: 100%;
            padding: 1rem;
            background: var(--black);
            color: var(--white);
            border: 2px solid var(--black);
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 1rem;
        }

        .btn:hover {
            background: var(--white);
            color: var(--black);
            transform: translateY(-2px);
            box-shadow: 0 4px 0 var(--black);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: none;
        }

        /* Settings */
        .settings-section {
            border-bottom: 2px solid var(--gray-mid);
            padding: 1.5rem 0;
        }

        .settings-section:last-child {
            border-bottom: none;
        }

        .settings-title {
            font-weight: 700;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-size: 0.85rem;
        }

        .settings-value {
            padding: 0.5rem 0;
            color: var(--gray-dark);
        }

        .settings-select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--black);
            font-size: 1rem;
            font-family: inherit;
            background: var(--white);
            cursor: pointer;
        }

        .btn-danger {
            background: var(--black);
            color: var(--white);
            border: 2px solid var(--black);
        }

        .btn-danger:hover {
            background: var(--gray-dark);
        }

        .library-item {
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--gray-mid);
        }

        .library-item:last-child {
            border-bottom: none;
        }

        .library-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .library-license {
            font-size: 0.85rem;
            color: var(--gray-dark);
        }

        .settings-text {
            line-height: 1.8;
            color: var(--gray-dark);
            padding: 0.5rem 0;
        }

        .privacy-content {
            line-height: 1.8;
            color: var(--gray-dark);
        }

        .privacy-content h3 {
            font-size: 1.1rem;
            font-weight: 700;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }

        .privacy-content h3:first-child {
            margin-top: 0;
        }

        .privacy-content p {
            margin-bottom: 1rem;
        }

        .privacy-content ul {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }

        .privacy-content li {
            margin-bottom: 0.5rem;
        }

        /* Custom Marker */
        .custom-marker {
            width: 40px;
            height: 40px;
            background: #ff0000;
            border: 3px solid var(--white);
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .custom-marker:hover {
            transform: rotate(-45deg) scale(1.2);
            box-shadow: 0 6px 16px rgba(0,0,0,0.6);
        }

        .custom-marker::after {
            content: '';
            position: absolute;
            width: 14px;
            height: 14px;
            background: var(--white);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* Leaflet Popup Customization */
        .leaflet-popup-content-wrapper {
            border: 2px solid var(--black);
            border-radius: 0;
            padding: 0;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.2);
        }

        .leaflet-popup-content {
            margin: 0;
            min-width: 200px;
        }

        .popup-header {
            background: var(--black);
            color: var(--white);
            padding: 0.75rem;
            font-weight: 700;
        }

        .popup-body {
            padding: 0.75rem;
        }

        .popup-date {
            font-size: 0.85rem;
            color: var(--gray-dark);
            margin-bottom: 0.5rem;
        }

        .popup-text {
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 0.75rem;
        }

        .popup-btn {
            display: block;
            width: 100%;
            padding: 0.5rem;
            background: var(--black);
            color: var(--white);
            text-align: center;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .popup-btn:hover {
            background: var(--gray-dark);
        }

        .popup-thumbnails {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .popup-thumbnail {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border: 2px solid var(--black);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .popup-thumbnail:hover {
            transform: scale(1.05);
        }

        .leaflet-popup-tip {
            border: 2px solid var(--black);
            background: var(--white);
        }

        /* Responsive Design */
        @media (max-width: 600px) {
            .modal-content {
                margin: 0;
                max-height: 100vh;
                border-left: none;
                border-right: none;
            }

            .detail-photos {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }

            .map-container {
                margin: 0.5rem;
                height: calc(100vh - 7rem - env(safe-area-inset-top) - env(safe-area-inset-bottom));
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div>
                <h1>Map Album</h1>
                <div class="header-subtitle">æ€ã„å‡ºã‚’åœ°å›³ã«åˆ»ã‚€</div>
            </div>
            <button class="settings-btn" id="settingsBtn">âš™</button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-button active" data-tab="list">ãƒªã‚¹ãƒˆ</button>
            <button class="tab-button" data-tab="map">ãƒãƒƒãƒ—</button>
        </div>

        <!-- List Tab -->
        <div class="tab-content active" id="listTab">
            <div class="memo-list" id="memoList">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“</div>
                    <div class="empty-state-text" id="emptyStateText">ã¾ã ãƒ¡ãƒ¢ãŒã‚ã‚Šã¾ã›ã‚“</div>
                    <div class="empty-state-subtext" id="emptyStateSubtext">å³ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰æ€ã„å‡ºã‚’è¿½åŠ ã—ã¾ã—ã‚‡ã†</div>
                </div>
            </div>
        </div>

        <!-- Map Tab -->
        <div class="tab-content" id="mapTab">
            <div class="map-container">
                <div id="viewMap"></div>
            </div>
        </div>
    </div>

    <!-- FAB Button -->
    <button class="fab" id="addBtn">
        +
        <span class="fab-badge" id="fabBadge">5</span>
    </button>

    <!-- Memo Detail Modal -->
    <div class="modal" id="memoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalLocation">å ´æ‰€å</h2>
                <button class="close-btn" onclick="closeMemoModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="detail-section">
                    <div class="detail-label" id="detailDateLabel">æ—¥æ™‚</div>
                    <div class="detail-content" id="modalDate"></div>
                </div>
                <div class="detail-section">
                    <div class="detail-label" id="detailMemoLabel">ãƒ¡ãƒ¢</div>
                    <div class="detail-content" id="modalMemo"></div>
                </div>
                <div class="detail-section">
                    <div class="detail-label" id="detailPhotoLabel">å†™çœŸ</div>
                    <div class="detail-photos" id="modalPhotos"></div>
                </div>
                <button class="btn-delete" onclick="deleteMemo()">å‰Šé™¤</button>
            </div>
        </div>
    </div>

    <!-- Add Photo Modal -->
    <div class="modal" id="addPhotoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>æ–°ã—ã„æ€ã„å‡ºã‚’è¿½åŠ </h2>
                <button class="close-btn" onclick="closeAddModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <form id="memoForm" onsubmit="saveMemo(event)">
                    <div class="form-group">
                        <label class="form-label" id="mapSelectLabel">åœ°å›³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦å ´æ‰€ã‚’é¸æŠ</label>
                        <div class="map-instructions">
                            åœ°å›³ä¸Šã®å¥½ããªå ´æ‰€ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãƒãƒ¼ã‚«ãƒ¼ã‚’é…ç½®ã—ã¦ãã ã•ã„
                        </div>
                        <div class="map-container-add">
                            <div id="addMap"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" id="locationNameFormLabel">å ´æ‰€ã®åå‰</label>
                        <input type="text" class="form-input" id="locationName" placeholder="ä¾‹: æ±äº¬ã‚¿ãƒ¯ãƒ¼ã€ãŠæ°—ã«å…¥ã‚Šã®ã‚«ãƒ•ã‚§">
                    </div>

                    <div class="form-group">
                        <label class="form-label" id="memoFormLabel">ãƒ¡ãƒ¢</label>
                        <textarea class="form-input" id="memoText" placeholder="ã“ã®å ´æ‰€ã§ã®æ€ã„å‡ºã‚’æ›¸ã„ã¦ãã ã•ã„..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label" id="photoFormLabel">å†™çœŸã‚’è¿½åŠ </label>
                        <div class="photo-upload-area" onclick="document.getElementById('photoInput').click()">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ“·</div>
                            <div id="photoUploadText">ã‚¿ãƒƒãƒ—ã—ã¦å†™çœŸã‚’é¸æŠ</div>
                            <input type="file" id="photoInput" accept="image/*" multiple onchange="handlePhotoSelect(event)">
                        </div>
                        <div class="photo-preview-grid" id="photoPreview"></div>
                    </div>

                    <button type="submit" class="btn" id="saveButton">ä¿å­˜</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="settingsModalTitle">è¨­å®š</h2>
                <button class="close-btn" onclick="closeSettingsModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <div class="settings-title" id="settingsVersionTitle">ãƒãƒ¼ã‚¸ãƒ§ãƒ³</div>
                    <div class="settings-value">v1.0.0</div>
                </div>

                <div class="settings-section">
                    <div class="settings-title" id="settingsNoticeTitle">ãŠçŸ¥ã‚‰ã›</div>
                    <button class="btn" onclick="showNotice()" style="background: #0066cc; color: white;" id="settingsNoticeButton">
                        ãŠçŸ¥ã‚‰ã›ã‚’è¦‹ã‚‹
                    </button>
                </div>

                <div class="settings-section">
                    <div class="settings-title" id="settingsLanguageTitle">è¨€èª / Language</div>
                    <select class="settings-select" id="languageSelect">
                        <option value="ja">æ—¥æœ¬èª</option>
                        <option value="en">English</option>
                    </select>
                </div>

                <div class="settings-section">
                    <div class="settings-title" id="settingsHowToTitle">ã“ã®ã‚¢ãƒ—ãƒªã®ä½¿ã„æ–¹</div>
                    <div class="settings-text" id="settingsHowToText">
                        1. å³ä¸‹ã®ã€Œ+ã€ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—<br>
                        2. åœ°å›³ä¸Šã§å ´æ‰€ã‚’é¸æŠ<br>
                        3. å†™çœŸã¨ãƒ¡ãƒ¢ã‚’è¿½åŠ <br>
                        4. ä¿å­˜ã—ã¦æ€ã„å‡ºã‚’è¨˜éŒ²
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-title" id="settingsPrivacyTitle">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</div>
                    <button class="btn" onclick="showPrivacyPolicy()" style="background: #0066cc; color: white;" id="settingsPrivacyButton">
                        ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã‚’è¦‹ã‚‹
                    </button>
                </div>

                <div class="settings-section">
                    <div class="settings-title" id="settingsAboutTitle">ã“ã®ã‚¢ãƒ—ãƒªã«ã¤ã„ã¦</div>
                    <button class="btn" onclick="showAbout()" style="background: #0066cc; color: white;" id="settingsAboutButton">
                        ã“ã®ã‚¢ãƒ—ãƒªã«ã¤ã„ã¦è¦‹ã‚‹
                    </button>
                </div>

                <div class="settings-section">
                    <div class="settings-title" id="settingsDataTitle">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</div>
                    <button class="btn btn-danger" id="exportDataButton" onclick="exportData()" style="margin-bottom: 0.5rem; background: #0066cc;">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    <button class="btn btn-danger" id="importDataButton" onclick="document.getElementById('importFileInput').click()" style="margin-bottom: 0.5rem; background: #0066cc;">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                    <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="importData(event)">
                    <button class="btn btn-danger" id="clearDataButton" onclick="clearAllData()" style="margin-bottom: 0.5rem;">ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤</button>
                    <button class="btn btn-danger" id="resetDatabaseButton" onclick="resetDatabase()" style="background: #666;">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
                </div>

                <div class="settings-section">
                    <div class="settings-title" id="settingsFeedbackTitle">ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</div>
                    <a href="https://docs.google.com/forms/d/e/1FAIpQLSe13BAEtXzH7X4yX1xajg7j7tXdkhsp-pf1ri2byigL1Oy97w/viewform" target="_blank" rel="noopener noreferrer" class="btn" style="display: block; text-align: center; background: #0066cc; color: white; text-decoration: none;" id="settingsFeedbackButton">
                        ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’é€ã‚‹
                    </a>
                </div>

                <div class="settings-section">
                    <div class="settings-title" id="settingsLibrariesTitle">ä½¿ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª</div>
                    <div class="library-item">
                        <div class="library-name">Leaflet v1.9.4</div>
                        <div class="library-license">BSD-2-Clause License</div>
                    </div>
                    <div class="library-item">
                        <div class="library-name">heic2any v0.0.4</div>
                        <div class="library-license">MIT License</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Privacy Policy Modal -->
    <div class="modal" id="privacyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="privacyModalTitle">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</h2>
                <button class="close-btn" onclick="closePrivacyModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="privacy-content" id="privacyContent">
                    <!-- ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã®å†…å®¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            </div>
        </div>
    </div>

    <!-- Notice Modal -->
    <div class="modal" id="noticeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="noticeModalTitle">ãŠçŸ¥ã‚‰ã›</h2>
                <button class="close-btn" onclick="closeNoticeModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="privacy-content" id="noticeContent">
                    <!-- ãŠçŸ¥ã‚‰ã›ã®å†…å®¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div class="modal" id="aboutModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="aboutModalTitle">ã“ã®ã‚¢ãƒ—ãƒªã«ã¤ã„ã¦</h2>
                <button class="close-btn" onclick="closeAboutModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="privacy-content" id="aboutContent">
                    <!-- ã“ã®ã‚¢ãƒ—ãƒªã«ã¤ã„ã¦ã®å†…å®¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global error handler
        window.onerror = function(message, source, lineno, colno, error) {
            console.error('Global error:', message, 'at', source, lineno, colno, error);
            return false;
        };

        window.onunhandledrejection = function(event) {
            console.error('Unhandled promise rejection:', event.reason);
        };

        // Translations
        const translations = {
            ja: {
                appTitle: 'Map Album',
                appSubtitle: 'æ€ã„å‡ºã‚’åœ°å›³ã«åˆ»ã‚€',
                tabList: 'ãƒªã‚¹ãƒˆ',
                tabMap: 'ãƒãƒƒãƒ—',
                emptyStateText: 'ã¾ã ãƒ¡ãƒ¢ãŒã‚ã‚Šã¾ã›ã‚“',
                emptyStateSubtext: 'å³ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰æ€ã„å‡ºã‚’è¿½åŠ ã—ã¾ã—ã‚‡ã†',
                addPhotoTitle: 'æ–°ã—ã„æ€ã„å‡ºã‚’è¿½åŠ ',
                mapInstruction: 'åœ°å›³ä¸Šã®å¥½ããªå ´æ‰€ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãƒãƒ¼ã‚«ãƒ¼ã‚’é…ç½®ã—ã¦ãã ã•ã„',
                locationNameLabel: 'å ´æ‰€ã®åå‰',
                locationNamePlaceholder: 'ä¾‹: æ±äº¬ã‚¿ãƒ¯ãƒ¼ã€ãŠæ°—ã«å…¥ã‚Šã®ã‚«ãƒ•ã‚§',
                memoLabel: 'ãƒ¡ãƒ¢',
                memoPlaceholder: 'ã“ã®å ´æ‰€ã§ã®æ€ã„å‡ºã‚’æ›¸ã„ã¦ãã ã•ã„...',
                photoLabel: 'å†™çœŸã‚’è¿½åŠ ',
                photoUploadText: 'ã‚¿ãƒƒãƒ—ã—ã¦å†™çœŸã‚’é¸æŠ',
                saveBtn: 'ä¿å­˜',
                deleteBtn: 'å‰Šé™¤',
                settingsTitle: 'è¨­å®š',
                settingsModalTitle: 'è¨­å®š',
                versionTitle: 'ãƒãƒ¼ã‚¸ãƒ§ãƒ³',
                versionValue: 'v1.0.0',
                noticeTitle: 'ãŠçŸ¥ã‚‰ã›',
                noticeButton: 'ãŠçŸ¥ã‚‰ã›ã‚’è¦‹ã‚‹',
                noticeModalTitle: 'ãŠçŸ¥ã‚‰ã›',
                languageTitle: 'è¨€èª / Language',
                howToTitle: 'ã“ã®ã‚¢ãƒ—ãƒªã®ä½¿ã„æ–¹',
                howToText: '1. å³ä¸‹ã®ã€Œ+ã€ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—<br>2. åœ°å›³ä¸Šã§å ´æ‰€ã‚’é¸æŠ<br>3. å†™çœŸã¨ãƒ¡ãƒ¢ã‚’è¿½åŠ <br>4. ä¿å­˜ã—ã¦æ€ã„å‡ºã‚’è¨˜éŒ²',
                privacyTitle: 'ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼',
                privacyButton: 'ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã‚’è¦‹ã‚‹',
                privacyModalTitle: 'ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼',
                aboutTitle: 'ã“ã®ã‚¢ãƒ—ãƒªã«ã¤ã„ã¦',
                aboutButton: 'ã“ã®ã‚¢ãƒ—ãƒªã«ã¤ã„ã¦è¦‹ã‚‹',
                aboutModalTitle: 'ã“ã®ã‚¢ãƒ—ãƒªã«ã¤ã„ã¦',
                aboutText: 'Map Albumã¯ã€ã‚ãªãŸã®æ€ã„å‡ºã‚’å†™çœŸã¨åœ°å›³ã§è¨˜éŒ²ã™ã‚‹ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¢ãƒ—ãƒªã§ã™ã€‚æ—…è¡Œã®æ€ã„å‡ºã‚„æ—¥å¸¸ã®ç‰¹åˆ¥ãªç¬é–“ã‚’ã€å ´æ‰€ã¨ä¸€ç·’ã«ä¿å­˜ã§ãã¾ã™ã€‚',
                dataManagementTitle: 'ãƒ‡ãƒ¼ã‚¿ç®¡ç†',
                feedbackTitle: 'ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯',
                feedbackButton: 'ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’é€ã‚‹',
                clearDataBtn: 'ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤',
                librariesTitle: 'ä½¿ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª',
                dateLabel: 'æ—¥æ™‚',
                photoLabel2: 'å†™çœŸ',
                detailBtn: 'è©³ç´°ã‚’è¦‹ã‚‹',
                clearAllConfirm1: 'æœ¬å½“ã«ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹?',
                clearAllConfirm2: 'ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚æœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹?',
                dataCleared: 'ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ',
                deleteError: 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ',
                photoCount: 'æšã®å†™çœŸ',
                noPhotos: 'å†™çœŸãªã—',
                selectLocation: 'åœ°å›³ä¸Šã§å ´æ‰€ã‚’é¸æŠã—ã¦ãã ã•ã„',
                saveFailed: 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ',
                deleteConfirm: 'æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹?',
                mapSelectLabel: 'åœ°å›³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦å ´æ‰€ã‚’é¸æŠ',
                resetDatabaseBtn: 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ',
                dailyLimitReached: 'æœ¬æ—¥ã®è¿½åŠ å›æ•°ã®ä¸Šé™ï¼ˆ5å›ï¼‰ã«é”ã—ã¾ã—ãŸã€‚æ˜æ—¥0æ™‚ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚',
                remainingAdds: 'æ®‹ã‚Šè¿½åŠ å›æ•°',
                exportData: 'ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ',
                importData: 'ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ',
                exportSuccess: 'ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ',
                importSuccess: 'ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ',
                importFailed: 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ',
                importConfirm: 'æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ'
            },
            en: {
                appTitle: 'Map Album',
                appSubtitle: 'Memories on the Map',
                tabList: 'List',
                tabMap: 'Map',
                emptyStateText: 'No memos yet',
                emptyStateSubtext: 'Tap the button below to add your memories',
                addPhotoTitle: 'Add New Memory',
                mapInstruction: 'Tap on the map to place a marker',
                locationNameLabel: 'Location Name',
                locationNamePlaceholder: 'e.g., Tokyo Tower, Favorite Cafe',
                memoLabel: 'Memo',
                memoPlaceholder: 'Write your memories about this place...',
                photoLabel: 'Add Photos',
                photoUploadText: 'Tap to select photos',
                saveBtn: 'Save',
                deleteBtn: 'Delete',
                settingsTitle: 'Settings',
                settingsModalTitle: 'Settings',
                versionTitle: 'Version',
                versionValue: 'v1.0.0',
                noticeTitle: 'Notice',
                noticeButton: 'View Notice',
                noticeModalTitle: 'Notice',
                languageTitle: 'Language / è¨€èª',
                howToTitle: 'How to Use',
                howToText: '1. Tap the "+" button at bottom right<br>2. Select a location on the map<br>3. Add photos and memo<br>4. Save to record your memory',
                privacyTitle: 'Privacy Policy',
                privacyButton: 'View Privacy Policy',
                privacyModalTitle: 'Privacy Policy',
                aboutTitle: 'About This App',
                aboutButton: 'View About This App',
                aboutModalTitle: 'About This App',
                aboutText: 'Map Album is a simple app to record your memories with photos and maps. Save your travel memories and special daily moments together with locations.',
                dataManagementTitle: 'Data Management',
                feedbackTitle: 'Feedback',
                feedbackButton: 'Send Feedback',
                clearDataBtn: 'Clear All Data',
                librariesTitle: 'Libraries Used',
                dateLabel: 'Date',
                photoLabel2: 'Photos',
                detailBtn: 'View Details',
                clearAllConfirm1: 'Are you sure you want to delete all data?',
                clearAllConfirm2: 'This action cannot be undone. Do you really want to proceed?',
                dataCleared: 'All data has been cleared',
                deleteError: 'Failed to delete',
                photoCount: ' photos',
                noPhotos: 'No photos',
                selectLocation: 'Please select a location on the map',
                saveFailed: 'Failed to save',
                deleteConfirm: 'Are you sure you want to delete this?',
                mapSelectLabel: 'Tap on the map to select location',
                resetDatabaseBtn: 'Reset Database',
                dailyLimitReached: 'Daily limit of 5 additions reached. Will reset at midnight.',
                remainingAdds: 'Remaining adds',
                exportData: 'Export Data',
                importData: 'Import Data',
                exportSuccess: 'Data exported successfully',
                importSuccess: 'Data imported successfully',
                importFailed: 'Failed to import data',
                importConfirm: 'Existing data will be overwritten. Are you sure?'
            }
        };

        let currentLanguage = localStorage.getItem('language') || 'ja';
        // Daily limit system
        const DAILY_LIMIT = 5;
        const LIMIT_KEY = 'dailyAddLimit';

        function getDailyLimitData() {
            const data = localStorage.getItem(LIMIT_KEY);
            if (!data) {
                return { count: 0, resetTime: getNextResetTime() };
            }
            return JSON.parse(data);
        }

        function getNextResetTime() {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);
            return tomorrow.getTime();
        }

        function getRemainingCount() {
            const data = getDailyLimitData();
            const now = Date.now();
            
            if (now >= data.resetTime) {
                const newData = { count: 0, resetTime: getNextResetTime() };
                localStorage.setItem(LIMIT_KEY, JSON.stringify(newData));
                return DAILY_LIMIT;
            }
            
            return Math.max(0, DAILY_LIMIT - data.count);
        }

        function incrementAddCount() {
            const data = getDailyLimitData();
            const now = Date.now();
            
            if (now >= data.resetTime) {
                data.count = 0;
                data.resetTime = getNextResetTime();
            }
            
            data.count += 1;
            localStorage.setItem(LIMIT_KEY, JSON.stringify(data));
            updateFabBadge();
        }

        function updateFabBadge() {
            const remaining = getRemainingCount();
            const badge = document.getElementById('fabBadge');
            const fabBtn = document.getElementById('addBtn');
            
            if (badge) {
                badge.textContent = remaining;
                if (remaining === 0) {
                    badge.classList.add('zero');
                } else {
                    badge.classList.remove('zero');
                }
            }
            
            if (fabBtn) {
                if (remaining === 0) {
                    fabBtn.classList.add('disabled');
                } else {
                    fabBtn.classList.remove('disabled');
                }
            }
        }

        function canAddMemo() {
            return getRemainingCount() > 0;
        }

        // IndexedDB
        const DB_NAME = 'MapAlbumDB';
        const DB_VERSION = 2;
        const STORE_NAME = 'memos';
        let db;

        function initDB() {
            return new Promise((resolve, reject) => {
                if (!window.indexedDB) {
                    reject(new Error('IndexedDB is not supported in this browser'));
                    return;
                }

                let timeoutId;
                const timeout = setTimeout(() => {
                    reject(new Error('Database initialization timeout'));
                }, 10000);

                try {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);

                    request.onerror = () => {
                        clearTimeout(timeout);
                        console.error('IndexedDB open error:', request.error);
                        reject(request.error || new Error('Failed to open database'));
                    };
                    
                    request.onsuccess = () => {
                        clearTimeout(timeout);
                        db = request.result;
                        console.log('Database opened successfully');
                        console.log('Object stores:', Array.from(db.objectStoreNames));
                        
                        db.onversionchange = () => {
                            db.close();
                            alert('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚\n\nDatabase was updated. Please reload the page.');
                        };

                        db.onerror = (event) => {
                            console.error('Database error:', event.target.error);
                        };
                        
                        if (!db.objectStoreNames.contains(STORE_NAME)) {
                            console.error('Object store not found, closing and recreating...');
                            db.close();
                            clearTimeout(timeout);
                            
                            const deleteRequest = indexedDB.deleteDatabase(DB_NAME);
                            deleteRequest.onsuccess = () => {
                                console.log('Database deleted, reinitializing...');
                                initDB().then(resolve).catch(reject);
                            };
                            deleteRequest.onerror = () => {
                                reject(new Error('Failed to delete corrupted database'));
                            };
                        } else {
                            resolve(db);
                        }
                    };

                    request.onupgradeneeded = (event) => {
                        console.log('Upgrading database...');
                        const db = event.target.result;
                        
                        try {
                            if (db.objectStoreNames.contains(STORE_NAME)) {
                                db.deleteObjectStore(STORE_NAME);
                                console.log('Deleted existing object store');
                            }
                            
                            const objectStore = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                            objectStore.createIndex('date', 'date', { unique: false });
                            objectStore.createIndex('location', 'location', { unique: false });
                            console.log('Created new object store');
                        } catch (upgradeError) {
                            console.error('Upgrade error:', upgradeError);
                            clearTimeout(timeout);
                            reject(upgradeError);
                        }
                    };

                    request.onblocked = () => {
                        clearTimeout(timeout);
                        console.warn('Database upgrade blocked. Please close other tabs with this app.');
                        alert('ä»–ã®ã‚¿ãƒ–ã§ã“ã®ã‚¢ãƒ—ãƒªãŒé–‹ã‹ã‚Œã¦ã„ã¾ã™ã€‚é–‰ã˜ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚\n\nThis app is open in another tab. Please close it and try again.');
                        reject(new Error('Database blocked'));
                    };
                } catch (error) {
                    clearTimeout(timeout);
                    console.error('Fatal error in initDB:', error);
                    reject(error);
                }
            });
        }

        // Tab Switching
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tabName = button.dataset.tab;
                
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                button.classList.add('active');
                document.getElementById(tabName + 'Tab').classList.add('active');

                if (tabName === 'map') {
                    setTimeout(() => {
                        if (viewMap) {
                            viewMap.invalidateSize();
                        }
                    }, 100);
                }
            });
        });

        // Maps
        let viewMap;
        let addMap;
        let marker;
        let selectedLocation = null;
        let selectedPhotos = [];
        let currentMemoId = null;

        function initViewMap() {
            viewMap = L.map('viewMap').setView([35.6762, 139.6503], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(viewMap);
        }

        function initAddMap() {
            addMap = L.map('addMap').setView([35.6762, 139.6503], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(addMap);

            addMap.on('click', (e) => {
                if (marker) {
                    addMap.removeLayer(marker);
                }

                const customIcon = L.divIcon({
                    className: 'custom-marker',
                    iconSize: [40, 40],
                    iconAnchor: [20, 40]
                });

                marker = L.marker(e.latlng, { icon: customIcon }).addTo(addMap);
                selectedLocation = e.latlng;
            });
        }

        function loadMemosOnMap() {
            if (!db || !viewMap) return;

            viewMap.eachLayer(layer => {
                if (layer instanceof L.Marker) {
                    viewMap.removeLayer(layer);
                }
            });

            const transaction = db.transaction([STORE_NAME], 'readonly');
            const objectStore = transaction.objectStore(STORE_NAME);
            const request = objectStore.getAll();

            request.onsuccess = () => {
                const memos = request.result;
                const t = translations[currentLanguage];
                
                memos.forEach(memo => {
                    const customIcon = L.divIcon({
                        className: 'custom-marker',
                        iconSize: [40, 40],
                        iconAnchor: [20, 40]
                    });

                    let thumbnailsHTML = '';
                    if (memo.photos && memo.photos.length > 0) {
                        const photosToShow = memo.photos.slice(0, 4);
                        thumbnailsHTML = `
                            <div class="popup-thumbnails">
                                ${photosToShow.map((photo, index) => 
                                    `<img src="${photo}" alt="Photo ${index + 1}" class="popup-thumbnail" onclick="window.open('${photo}', '_blank')">`
                                ).join('')}
                            </div>
                        `;
                    }

                    const popupContent = `
                        <div class="popup-header">${memo.locationName}</div>
                        <div class="popup-body">
                            <div class="popup-date">${new Date(memo.date).toLocaleDateString(currentLanguage === 'ja' ? 'ja-JP' : 'en-US')}</div>
                            ${memo.memo ? `<div class="popup-text">${memo.memo.substring(0, 50)}${memo.memo.length > 50 ? '...' : ''}</div>` : ''}
                            ${thumbnailsHTML}
                            <button class="popup-btn" onclick="openMemoModal(${memo.id})">${t.detailBtn}</button>
                        </div>
                    `;

                    L.marker([memo.lat, memo.lng], { icon: customIcon })
                        .addTo(viewMap)
                        .bindPopup(popupContent);
                });
            };
        }

        // Load Memos
        function loadMemos() {
            if (!db) return;
            
            const t = translations[currentLanguage];
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const objectStore = transaction.objectStore(STORE_NAME);
            const request = objectStore.getAll();

            request.onsuccess = () => {
                const memos = request.result.sort((a, b) => new Date(b.date) - new Date(a.date));
                const memoList = document.getElementById('memoList');

                if (memos.length === 0) {
                    memoList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“</div>
                            <div class="empty-state-text">${t.emptyStateText}</div>
                            <div class="empty-state-subtext">${t.emptyStateSubtext}</div>
                        </div>
                    `;
                    return;
                }

                memoList.innerHTML = memos.map(memo => {
                    let thumbnailsHTML = '';
                    if (memo.photos && memo.photos.length > 0) {
                        const photosToShow = memo.photos.slice(0, 4);
                        thumbnailsHTML = `
                            <div class="memo-thumbnails">
                                ${photosToShow.map(photo => 
                                    `<img src="${photo}" alt="Thumbnail" class="memo-thumbnail">`
                                ).join('')}
                            </div>
                        `;
                    }

                    return `
                        <div class="memo-card" data-memo-id="${memo.id}" onclick="openMemoModal(${memo.id})">
                            <div class="memo-card-header">
                                <div>
                                    <div class="memo-location">${memo.locationName}</div>
                                    <div class="memo-date">${new Date(memo.date).toLocaleDateString(currentLanguage === 'ja' ? 'ja-JP' : 'en-US')}</div>
                                </div>
                            </div>
                            ${memo.memo ? `<div class="memo-preview">${memo.memo}</div>` : ''}
                            ${thumbnailsHTML}
                            ${memo.photos && memo.photos.length > 0 ? `<span class="memo-photo-count">${memo.photos.length}${t.photoCount}</span>` : ''}
                        </div>
                    `;
                }).join('');
            };
        }

        // Open/Close Memo Modal
        function openMemoModal(memoId) {
            if (!db) return;
            
            currentMemoId = memoId;
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const objectStore = transaction.objectStore(STORE_NAME);
            const request = objectStore.get(memoId);

            request.onsuccess = () => {
                const memo = request.result;
                const t = translations[currentLanguage];
                
                document.getElementById('modalLocation').textContent = memo.locationName;
                document.getElementById('modalDate').textContent = new Date(memo.date).toLocaleString(currentLanguage === 'ja' ? 'ja-JP' : 'en-US');
                document.getElementById('modalMemo').textContent = memo.memo || '-';
                
                document.getElementById('detailDateLabel').textContent = t.dateLabel;
                document.getElementById('detailMemoLabel').textContent = t.memoLabel;
                document.getElementById('detailPhotoLabel').textContent = t.photoLabel2;
                
                const photosContainer = document.getElementById('modalPhotos');
                if (memo.photos && memo.photos.length > 0) {
                    photosContainer.innerHTML = memo.photos.map(photo => 
                        `<img src="${photo}" alt="Photo" class="detail-photo" onclick="window.open('${photo}', '_blank')">`
                    ).join('');
                } else {
                    photosContainer.innerHTML = `<div style="color: var(--gray-dark);">${t.noPhotos}</div>`;
                }

                document.getElementById('memoModal').classList.add('active');
            };
        }

        function closeMemoModal() {
            document.getElementById('memoModal').classList.remove('active');
            currentMemoId = null;
        }

        // Delete Memo
        function deleteMemo() {
            const t = translations[currentLanguage];
            if (!currentMemoId || !db) return;
            
            if (!confirm(t.deleteConfirm)) return;

            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const objectStore = transaction.objectStore(STORE_NAME);
            const request = objectStore.delete(currentMemoId);

            request.onsuccess = () => {
                closeMemoModal();
                loadMemos();
                loadMemosOnMap();
            };

            request.onerror = () => {
                alert(t.deleteError);
            };
        }

        // Photo handling
        async function handlePhotoSelect(event) {
            const files = Array.from(event.target.files);
            
            for (const file of files) {
                try {
                    let fileToProcess = file;
                    
                    if (file.type === 'image/heic' || file.type === 'image/heif' || file.name.toLowerCase().endsWith('.heic') || file.name.toLowerCase().endsWith('.heif')) {
                        console.log('Converting HEIC/HEIF to JPEG...');
                        try {
                            if (typeof heic2any === 'undefined') {
                                alert('HEICå½¢å¼ã®ã‚µãƒãƒ¼ãƒˆãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚JPEGã¾ãŸã¯PNGå½¢å¼ã§ãŠè©¦ã—ãã ã•ã„ã€‚\n\nHEIC format is not supported. Please try JPEG or PNG format.');
                                continue;
                            }
                            
                            let convertedBlob = await heic2any({
                                blob: file,
                                toType: 'image/jpeg',
                                quality: 0.8
                            });
                            
                            if (Array.isArray(convertedBlob)) {
                                convertedBlob = convertedBlob[0];
                            }
                            
                            fileToProcess = new File([convertedBlob], file.name.replace(/\.heic$/i, '.jpg'), { type: 'image/jpeg' });
                            console.log('HEIC conversion successful');
                        } catch (heicError) {
                            console.error('HEIC conversion failed:', heicError);
                            alert('HEICå½¢å¼ã®å¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸã€‚åˆ¥ã®å½¢å¼ã§ãŠè©¦ã—ãã ã•ã„ã€‚\n\nFailed to convert HEIC format. Please try another format.');
                            continue;
                        }
                    }
                    
                    compressImage(fileToProcess, (compressedDataUrl) => {
                        selectedPhotos.push(compressedDataUrl);
                        renderPhotoPreview();
                    });
                } catch (error) {
                    console.error('Error processing file:', file.name, error);
                }
            }
            
            event.target.value = '';
        }

        function compressImage(file, callback) {
            try {
                if (!file || !file.type) {
                    console.error('Invalid file object');
                    return;
                }
                
                if (!file.type.match(/image.*/)) {
                    console.error('Not an image file:', file.type);
                    return;
                }

                const reader = new FileReader();
                reader.onerror = (error) => {
                    console.error('FileReader error:', error);
                    console.warn('Skipping file due to read error');
                };
                reader.onload = (e) => {
                    try {
                        const img = new Image();
                        img.onerror = (error) => {
                            console.error('Image load error for file:', file.name, error);
                            console.warn('Skipping file due to image load error');
                        };
                        img.onload = () => {
                            try {
                                const canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d');
                                
                                if (!ctx) {
                                    console.error('Failed to get canvas context');
                                    return;
                                }
                                
                                const maxSize = 1200;
                                let width = img.width;
                                let height = img.height;
                                
                                if (width === 0 || height === 0 || !isFinite(width) || !isFinite(height)) {
                                    console.error('Invalid image dimensions:', width, height);
                                    return;
                                }
                                
                                if (width > height) {
                                    if (width > maxSize) {
                                        height = Math.round((height * maxSize) / width);
                                        width = maxSize;
                                    }
                                } else {
                                    if (height > maxSize) {
                                        width = Math.round((width * maxSize) / height);
                                        height = maxSize;
                                    }
                                }
                                
                                canvas.width = width;
                                canvas.height = height;
                                
                                ctx.fillStyle = '#FFFFFF';
                                ctx.fillRect(0, 0, width, height);
                                
                                ctx.drawImage(img, 0, 0, width, height);
                                
                                const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
                                
                                const sizeInMB = (compressedDataUrl.length * 0.75) / (1024 * 1024);
                                if (sizeInMB > 5) {
                                    console.warn('Compressed image still too large:', sizeInMB.toFixed(2), 'MB');
                                    const furtherCompressed = canvas.toDataURL('image/jpeg', 0.5);
                                    callback(furtherCompressed);
                                } else {
                                    callback(compressedDataUrl);
                                }
                            } catch (canvasError) {
                                console.error('Canvas error:', canvasError);
                                console.warn('Skipping file due to compression error');
                            }
                        };
                        
                        if (e.target && e.target.result) {
                            img.src = e.target.result;
                        } else {
                            console.error('FileReader result is empty');
                        }
                    } catch (imgError) {
                        console.error('Image processing error:', imgError);
                    }
                };
                reader.readAsDataURL(file);
            } catch (error) {
                console.error('compressImage fatal error:', error);
            }
        }

        function renderPhotoPreview() {
            const previewContainer = document.getElementById('photoPreview');
            previewContainer.innerHTML = selectedPhotos.map((photo, index) => `
                <div class="photo-preview-item">
                    <img src="${photo}" alt="Preview ${index + 1}" class="photo-preview-img">
                    <button type="button" class="photo-remove" onclick="removePhoto(${index})">Ã—</button>
                </div>
            `).join('');
        }

        function removePhoto(index) {
            selectedPhotos.splice(index, 1);
            renderPhotoPreview();
        }
        // Save Memo
        function saveMemo(event) {
            event.preventDefault();
            console.log('saveMemo called');
            const t = translations[currentLanguage];

            if (!selectedLocation) {
                alert(t.selectLocation);
                return;
            }

            if (!db) {
                alert(t.saveFailed);
                return;
            }

            const locationName = document.getElementById('locationName').value.trim();
            const memoText = document.getElementById('memoText').value.trim();

            const memo = {
                locationName: locationName || (currentLanguage === 'ja' ? 'åç§°æœªè¨­å®š' : 'Untitled'),
                memo: memoText,
                lat: selectedLocation.lat,
                lng: selectedLocation.lng,
                photos: selectedPhotos.slice(),
                date: new Date().toISOString()
            };

            console.log('Saving memo:', memo);

            try {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.add(memo);

                request.onsuccess = () => {
                    console.log('Memo saved successfully');
                    incrementAddCount();
                    closeAddModal();
                    loadMemos();
                    loadMemosOnMap();
                };

                request.onerror = (e) => {
                    console.error('Save error:', e.target.error);
                    alert(t.saveFailed + ': ' + e.target.error.message);
                };

                transaction.onerror = (e) => {
                    console.error('Transaction error:', e.target.error);
                    alert(t.saveFailed);
                };
            } catch (error) {
                console.error('Exception in saveMemo:', error);
                alert(t.saveFailed + ': ' + error.message);
            }
        }

        // Add Button
        document.getElementById('addBtn').addEventListener('click', () => {
            const t = translations[currentLanguage];
            
            if (!canAddMemo()) {
                alert(t.dailyLimitReached);
                return;
            }
            
            document.getElementById('addPhotoModal').classList.add('active');
            setTimeout(() => {
                if (!addMap) {
                    initAddMap();
                } else {
                    addMap.invalidateSize();
                }
            }, 100);
        });

        function closeAddModal() {
            document.getElementById('addPhotoModal').classList.remove('active');
            document.getElementById('memoForm').reset();
            document.getElementById('locationName').value = '';
            document.getElementById('memoText').value = '';
            selectedPhotos = [];
            renderPhotoPreview();
            if (marker && addMap) {
                addMap.removeLayer(marker);
                marker = null;
            }
            selectedLocation = null;
        }

        // Click outside modal to close
        document.getElementById('memoModal').addEventListener('click', (e) => {
            if (e.target.id === 'memoModal') {
                closeMemoModal();
            }
        });

        document.getElementById('addPhotoModal').addEventListener('click', (e) => {
            if (e.target.id === 'addPhotoModal') {
                closeAddModal();
            }
        });

        document.getElementById('settingsModal').addEventListener('click', (e) => {
            if (e.target.id === 'settingsModal') {
                closeSettingsModal();
            }
        });

        document.getElementById('privacyModal').addEventListener('click', (e) => {
            if (e.target.id === 'privacyModal') {
                closePrivacyModal();
            }
        });

        document.getElementById('noticeModal').addEventListener('click', (e) => {
            if (e.target.id === 'noticeModal') {
                closeNoticeModal();
            }
        });

        document.getElementById('aboutModal').addEventListener('click', (e) => {
            if (e.target.id === 'aboutModal') {
                closeAboutModal();
            }
        });

        // Settings
        document.getElementById('settingsBtn').addEventListener('click', () => {
            document.getElementById('settingsModal').classList.add('active');
            loadSettings();
        });

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function closePrivacyModal() {
            document.getElementById('privacyModal').classList.remove('active');
        }

        function closeNoticeModal() {
            document.getElementById('noticeModal').classList.remove('active');
        }

        function closeAboutModal() {
            document.getElementById('aboutModal').classList.remove('active');
        }

        function showNotice() {
            const modal = document.getElementById('noticeModal');
            const content = document.getElementById('noticeContent');
            const t = translations[currentLanguage];
            
            if (currentLanguage === 'ja') {
                content.innerHTML = `
                    <p>ãŠçŸ¥ã‚‰ã›ã®å†…å®¹ã¯å¾Œæ—¥è¿½åŠ äºˆå®šã§ã™ã€‚</p>
                `;
            } else {
                content.innerHTML = `
                    <p>Notice content will be added soon.</p>
                `;
            }
            
            modal.classList.add('active');
        }

        function showAbout() {
            const modal = document.getElementById('aboutModal');
            const content = document.getElementById('aboutContent');
            const t = translations[currentLanguage];
            
            if (currentLanguage === 'ja') {
                content.innerHTML = `
                    <p>Map Albumã¯ã€ã‚ãªãŸã®æ€ã„å‡ºã‚’å†™çœŸã¨åœ°å›³ã§è¨˜éŒ²ã™ã‚‹ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¢ãƒ—ãƒªã§ã™ã€‚æ—…è¡Œã®æ€ã„å‡ºã‚„æ—¥å¸¸ã®ç‰¹åˆ¥ãªç¬é–“ã‚’ã€å ´æ‰€ã¨ä¸€ç·’ã«ä¿å­˜ã§ãã¾ã™ã€‚</p>
                    
                    <p>ã“ã®Map Albumã‚’é–‹ç™ºã—ãŸç›®çš„ã¨ã—ã¦ã¯ã€è‡ªåˆ†ã®æ’®ã£ãŸå†™çœŸã‚’è‡ªåˆ†ã ã‘ã®åœ°å›³ã«è¼‰ã›ãŸã„ã‹ã‚‰ã ã€‚ã™ã§ã«ä¼¼ã¦ã„ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã¯å­˜åœ¨ã—ã¦ã„ã‚‹ãŒã€ä»–ã¨é•ã£ã¦åƒ•ãŒæ¬²ã—ã„ã¨æ€ã£ãŸä¼šå“¡ç™»éŒ²ä¸è¦ã€åŸºæœ¬ç„¡æ–™ã€ä½¿ã„ã‚„ã™ã•ã‚’é‡è¦–ã—ã¦ã„ã‚‹ã€‚ã“ã‚Œã‹ã‚‰ã‚‚æ”¹å–„ã‚’ç¶šã‘ã¦ã„ãã¤ã‚‚ã‚Šã ã€‚</p>
                    
                    <p>ãœã²è‡ªåˆ†ã ã‘ã®æ€ã„å‡ºã®åœ°å›³ã‚’ä½œã£ã¦ã€æ¥½ã—ã‚“ã§ï¼ï¼</p>
                `;
            } else {
                content.innerHTML = `
                    <p>Map Album is a simple app to record your memories with photos and maps. Save your travel memories and special daily moments together with locations.</p>
                    
                    <p>The purpose of developing Map Album is to put my own photos on my own map. There are already similar services out there, but unlike others, I focused on what I wanted: no registration required, basically free, and ease of use. I will continue to improve it.</p>
                    
                    <p>Create your own memory map and enjoy!!</p>
                `;
            }
            
            modal.classList.add('active');
        }

        function showPrivacyPolicy() {
            const modal = document.getElementById('privacyModal');
            const content = document.getElementById('privacyContent');
            const t = translations[currentLanguage];
            
            if (currentLanguage === 'ja') {
                content.innerHTML = `
                    <p style="text-align: center; margin-bottom: 1.5rem;">
                        <a href="privacy.html" target="_blank" style="color: #0066cc; text-decoration: underline;">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã‚’è¦‹ã‚‹ / Privacy Policy</a>
                    </p>
                    
                    <h3>1. ã¯ã˜ã‚ã«</h3>
                    <p>æœ¬ã‚¢ãƒ—ãƒªã€ŒMap Albumã€ï¼ˆä»¥ä¸‹ã€Œå½“ã‚¢ãƒ—ãƒªã€ï¼‰ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®çš†æ§˜ã®ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã‚’å°Šé‡ã—ã€å€‹äººæƒ…å ±ã®ä¿è­·ã«åŠªã‚ã¦ã„ã¾ã™ã€‚</p>
                    
                    <h3>2. åé›†ã™ã‚‹æƒ…å ±</h3>
                    <p>å½“ã‚¢ãƒ—ãƒªã¯ä»¥ä¸‹ã®æƒ…å ±ã‚’åé›†ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼š</p>
                    <ul>
                        <li>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¿½åŠ ã—ãŸå†™çœŸã€ãƒ¡ãƒ¢ã€ä½ç½®æƒ…å ±</li>
                        <li>ã‚¢ãƒ—ãƒªã®ä½¿ç”¨çŠ¶æ³ã«é–¢ã™ã‚‹æƒ…å ±</li>
                        <li>Google AdSenseã«ã‚ˆã‚‹åºƒå‘Šé…ä¿¡ã®ãŸã‚ã®æƒ…å ±ï¼ˆCookieç­‰ï¼‰</li>
                    </ul>
                    
                    <h3>3. æƒ…å ±ã®ä½¿ç”¨ç›®çš„</h3>
                    <p>åé›†ã—ãŸæƒ…å ±ã¯ä»¥ä¸‹ã®ç›®çš„ã§ä½¿ç”¨ã•ã‚Œã¾ã™ï¼š</p>
                    <ul>
                        <li>ã‚¢ãƒ—ãƒªæ©Ÿèƒ½ã®æä¾›ï¼ˆæ€ã„å‡ºã®è¨˜éŒ²ã¨è¡¨ç¤ºï¼‰</li>
                        <li>ã‚¢ãƒ—ãƒªã®æ”¹å–„ã¨æ©Ÿèƒ½è¿½åŠ </li>
                        <li>Google AdSenseã«ã‚ˆã‚‹åºƒå‘Šé…ä¿¡ã®æœ€é©åŒ–</li>
                    </ul>
                    
                    <h3>4. ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜</h3>
                    <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¿½åŠ ã—ãŸã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆå†™çœŸã€ãƒ¡ãƒ¢ã€ä½ç½®æƒ…å ±ï¼‰ã¯ã€ãƒ‡ãƒã‚¤ã‚¹ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆIndexedDBï¼‰ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ã€‚å½“ã‚¢ãƒ—ãƒªã®é–‹ç™ºè€…ã‚„ç¬¬ä¸‰è€…ã®ã‚µãƒ¼ãƒãƒ¼ã«ã¯ä¸€åˆ‡é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã€‚</p>
                    
                    <h3>5. Google AdSenseã«ã¤ã„ã¦</h3>
                    <p>å½“ã‚¢ãƒ—ãƒªã§ã¯Google AdSenseã‚’ä½¿ç”¨ã—ã¦åºƒå‘Šã‚’é…ä¿¡ã—ã¦ã„ã¾ã™ã€‚Google AdSenseã¯ã€Cookieã‚’ä½¿ç”¨ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èˆˆå‘³ã«åŸºã¥ã„ãŸåºƒå‘Šã‚’è¡¨ç¤ºã—ã¾ã™ã€‚Cookieã‚’ä½¿ç”¨ã—ãŸåºƒå‘Šé…ä¿¡ã‚’ç„¡åŠ¹ã«ã™ã‚‹å ´åˆã¯ã€Googleã®åºƒå‘Šè¨­å®šãƒšãƒ¼ã‚¸ã§è¨­å®šã‚’å¤‰æ›´ã§ãã¾ã™ã€‚</p>
                    <p>è©³ç´°ã«ã¤ã„ã¦ã¯ã€<a href="https://policies.google.com/technologies/ads?hl=ja" target="_blank" rel="noopener noreferrer">Googleã®åºƒå‘Šãƒãƒªã‚·ãƒ¼</a>ã‚’ã”ç¢ºèªãã ã•ã„ã€‚</p>
                    
                    <h3>6. ãƒ‡ãƒ¼ã‚¿ã®ç¬¬ä¸‰è€…æä¾›</h3>
                    <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å€‹äººãƒ‡ãƒ¼ã‚¿ã‚’ç¬¬ä¸‰è€…ã«è²©å£²ã€å…±æœ‰ã€ã¾ãŸã¯æä¾›ã™ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãŸã ã—ã€Google AdSenseã«ã‚ˆã‚‹åºƒå‘Šé…ä¿¡ã®ãŸã‚ã«å¿…è¦ãªç¯„å›²ã§ã€Googleã«ãƒ‡ãƒ¼ã‚¿ãŒé€ä¿¡ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</p>
                    
                    <h3>7. ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤</h3>
                    <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€ã‚¢ãƒ—ãƒªã®è¨­å®šç”»é¢ã‹ã‚‰ã„ã¤ã§ã‚‚ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã§ãã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã™ã‚‹ã¨ã€ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰å®Œå…¨ã«å‰Šé™¤ã•ã‚Œã€å¾©å…ƒã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚</p>
                    
                    <h3>8. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</h3>
                    <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã¯ãƒ‡ãƒã‚¤ã‚¹ä¸Šã§ã®ã¿ä¿å­˜ã•ã‚Œã‚‹ãŸã‚ã€ãƒ‡ãƒã‚¤ã‚¹ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã«ã‚ˆã£ã¦ä¿è­·ã•ã‚Œã¾ã™ã€‚ãƒ‡ãƒã‚¤ã‚¹ã®ç´›å¤±ã‚„ç›—é›£ã«ã¯ã”æ³¨æ„ãã ã•ã„ã€‚</p>
                    
                    <h3>9. ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã®å¤‰æ›´</h3>
                    <p>æœ¬ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã¯ã€å¿…è¦ã«å¿œã˜ã¦å¤‰æ›´ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚é‡è¦ãªå¤‰æ›´ãŒã‚ã‚‹å ´åˆã¯ã€ã‚¢ãƒ—ãƒªå†…ã§ãŠçŸ¥ã‚‰ã›ã—ã¾ã™ã€‚</p>
                    
                    <h3>10. ãŠå•ã„åˆã‚ã›</h3>
                    <p>æœ¬ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã«é–¢ã™ã‚‹ã”è³ªå•ã‚„ã”æ„è¦‹ã¯ã€ã‚¢ãƒ—ãƒªå†…ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ãŠé€ã‚Šãã ã•ã„ã€‚</p>
                    
                    <p><small>æœ€çµ‚æ›´æ–°æ—¥: 2026å¹´2æœˆ</small></p>
                `;
            } else {
                content.innerHTML = `
                    <p style="text-align: center; margin-bottom: 1.5rem;">
                        <a href="privacy.html" target="_blank" style="color: #0066cc; text-decoration: underline;">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã‚’è¦‹ã‚‹ / Privacy Policy</a>
                    </p>
                    
                    <h3>1. Introduction</h3>
                    <p>This app "Map Album" (hereinafter "the App") respects the privacy of users and is committed to protecting personal information.</p>
                    
                    <h3>2. Information We Collect</h3>
                    <p>The App may collect the following information:</p>
                    <ul>
                        <li>Photos, memos, and location information added by users</li>
                        <li>Information about app usage</li>
                        <li>Information for ad delivery by Google AdSense (Cookies, etc.)</li>
                    </ul>
                    
                    <h3>3. Purpose of Use</h3>
                    <p>Collected information is used for the following purposes:</p>
                    <ul>
                        <li>Providing app functionality (recording and displaying memories)</li>
                        <li>Improving the app and adding features</li>
                        <li>Optimizing ad delivery by Google AdSense</li>
                    </ul>
                    
                    <h3>4. Data Storage</h3>
                    <p>All user-added data (photos, memos, location information) is stored only in the device's local storage (IndexedDB). It is never sent to the app developer's or any third-party servers.</p>
                    
                    <h3>5. About Google AdSense</h3>
                    <p>The App uses Google AdSense to deliver advertisements. Google AdSense uses Cookies to display ads based on user interests. If you want to disable cookie-based ad delivery, you can change settings on Google's ad settings page.</p>
                    <p>For more details, please see <a href="https://policies.google.com/technologies/ads" target="_blank" rel="noopener noreferrer">Google's Advertising Policies</a>.</p>
                    
                    <h3>6. Data Sharing with Third Parties</h3>
                    <p>We do not sell, share, or provide user personal data to third parties. However, data may be sent to Google as necessary for ad delivery by Google AdSense.</p>
                    
                    <h3>7. Data Deletion</h3>
                    <p>Users can delete all data at any time from the app's settings screen. Once deleted, data is completely removed from the device and cannot be recovered.</p>
                    
                    <h3>8. Security</h3>
                    <p>User data is stored only on the device and is protected by device security settings. Please be careful about device loss or theft.</p>
                    
                    <h3>9. Privacy Policy Changes</h3>
                    <p>This Privacy Policy may be changed as necessary. If there are significant changes, we will notify you within the app.</p>
                    
                    <h3>10. Contact</h3>
                    <p>For questions or comments regarding this Privacy Policy, please send them through the in-app feedback form.</p>
                    
                    <p><small>Last Updated: February 2026</small></p>
                `;
            }
            
            modal.classList.add('active');
        }

        function loadSettings() {
            const savedLanguage = localStorage.getItem('language') || 'ja';
            document.getElementById('languageSelect').value = savedLanguage;
        }

        document.getElementById('languageSelect').addEventListener('change', (e) => {
            const language = e.target.value;
            localStorage.setItem('language', language);
            applyLanguage(language);
        });

        function applyLanguage(lang) {
            currentLanguage = lang;
            const t = translations[lang];
            
            document.querySelector('.header h1').textContent = t.appTitle;
            document.querySelector('.header-subtitle').textContent = t.appSubtitle;
            
            document.querySelectorAll('.tab-button')[0].textContent = t.tabList;
            document.querySelectorAll('.tab-button')[1].textContent = t.tabMap;
            
            const emptyStateText = document.getElementById('emptyStateText');
            const emptyStateSubtext = document.getElementById('emptyStateSubtext');
            if (emptyStateText) emptyStateText.textContent = t.emptyStateText;
            if (emptyStateSubtext) emptyStateSubtext.textContent = t.emptyStateSubtext;
            
            document.querySelector('#addPhotoModal .modal-header h2').textContent = t.addPhotoTitle;
            document.querySelector('.map-instructions').textContent = t.mapInstruction;
            document.getElementById('mapSelectLabel').textContent = t.mapSelectLabel;
            document.getElementById('locationNameFormLabel').textContent = t.locationNameLabel;
            document.getElementById('locationName').placeholder = t.locationNamePlaceholder;
            document.getElementById('memoFormLabel').textContent = t.memoLabel;
            document.getElementById('memoText').placeholder = t.memoPlaceholder;
            document.getElementById('photoFormLabel').textContent = t.photoLabel;
            document.getElementById('photoUploadText').textContent = t.photoUploadText;
            document.getElementById('saveButton').textContent = t.saveBtn;
            
            document.querySelector('.btn-delete').textContent = t.deleteBtn;
            
            document.querySelector('#settingsModalTitle').textContent = t.settingsModalTitle || t.settingsTitle;
            document.getElementById('settingsVersionTitle').textContent = t.versionTitle;
            document.getElementById('settingsNoticeTitle').textContent = t.noticeTitle;
            document.getElementById('settingsNoticeButton').textContent = t.noticeButton;
            document.getElementById('settingsLanguageTitle').textContent = t.languageTitle;
            document.getElementById('settingsHowToTitle').textContent = t.howToTitle;
            document.getElementById('settingsHowToText').innerHTML = t.howToText;
            document.getElementById('settingsPrivacyTitle').textContent = t.privacyTitle;
            document.getElementById('settingsPrivacyButton').textContent = t.privacyButton;
            document.getElementById('settingsAboutTitle').textContent = t.aboutTitle;
            document.getElementById('settingsAboutButton').textContent = t.aboutButton;
            document.getElementById('settingsDataTitle').textContent = t.dataManagementTitle;
            document.getElementById('exportDataButton').textContent = t.exportData;
            document.getElementById('importDataButton').textContent = t.importData;
            document.getElementById('clearDataButton').textContent = t.clearDataBtn;
            document.getElementById('resetDatabaseButton').textContent = t.resetDatabaseBtn;
            document.getElementById('settingsFeedbackTitle').textContent = t.feedbackTitle;
            document.getElementById('settingsFeedbackButton').textContent = t.feedbackButton;
            document.getElementById('settingsLibrariesTitle').textContent = t.librariesTitle;
            
            document.getElementById('privacyModalTitle').textContent = t.privacyModalTitle;
            document.getElementById('noticeModalTitle').textContent = t.noticeModalTitle;
            document.getElementById('aboutModalTitle').textContent = t.aboutModalTitle;
            
            loadMemos();
            loadMemosOnMap();
        }

        function clearAllData() {
            const t = translations[currentLanguage];
            if (!confirm(t.clearAllConfirm1)) return;
            
            if (!confirm(t.clearAllConfirm2)) return;

            if (!db) {
                alert(t.deleteError);
                return;
            }

            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const objectStore = transaction.objectStore(STORE_NAME);
            const request = objectStore.clear();

            request.onsuccess = () => {
                alert(t.dataCleared);
                closeSettingsModal();
                loadMemos();
                loadMemosOnMap();
            };

            request.onerror = () => {
                alert(t.deleteError);
            };
        }

        function resetDatabase() {
            const t = translations[currentLanguage];
            if (!confirm('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å®Œå…¨ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\nReset database completely. All data will be deleted. Are you sure?')) {
                return;
            }

            if (db) {
                db.close();
            }

            const deleteRequest = indexedDB.deleteDatabase(DB_NAME);
            
            deleteRequest.onsuccess = () => {
                alert('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã€‚\n\nDatabase reset. Reloading page...');
                location.reload();
            };

            deleteRequest.onerror = () => {
                alert('ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nFailed to reset database.');
            };

            deleteRequest.onblocked = () => {
                alert('ä»–ã®ã‚¿ãƒ–ã§ã“ã®ã‚¢ãƒ—ãƒªãŒé–‹ã‹ã‚Œã¦ã„ã¾ã™ã€‚é–‰ã˜ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚\n\nThis app is open in another tab. Please close it and try again.');
            };
        }

        async function exportData() {
            const t = translations[currentLanguage];
            
            if (!db) {
                alert(t.saveFailed);
                return;
            }

            try {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.getAll();

                request.onsuccess = () => {
                    const memos = request.result;
                    const exportData = {
                        version: '1.0.0',
                        exportDate: new Date().toISOString(),
                        memos: memos
                    };

                    const dataStr = JSON.stringify(exportData, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `map-album-backup-${new Date().toISOString().slice(0, 10)}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);

                    alert(t.exportSuccess);
                };

                request.onerror = () => {
                    alert(t.saveFailed);
                };
            } catch (error) {
                console.error('Export error:', error);
                alert(t.saveFailed);
            }
        }

        async function importData(event) {
            const t = translations[currentLanguage];
            const file = event.target.files[0];
            
            if (!file) return;

            if (!confirm(t.importConfirm)) {
                event.target.value = '';
                return;
            }

            try {
                const text = await file.text();
                const importData = JSON.parse(text);

                if (!importData.memos || !Array.isArray(importData.memos)) {
                    throw new Error('Invalid data format');
                }

                if (!db) {
                    alert(t.importFailed);
                    event.target.value = '';
                    return;
                }

                const clearTransaction = db.transaction([STORE_NAME], 'readwrite');
                const clearStore = clearTransaction.objectStore(STORE_NAME);
                await new Promise((resolve, reject) => {
                    const clearRequest = clearStore.clear();
                    clearRequest.onsuccess = resolve;
                    clearRequest.onerror = reject;
                });

                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(STORE_NAME);

                for (const memo of importData.memos) {
                    const { id, ...memoWithoutId } = memo;
                    objectStore.add(memoWithoutId);
                }

                transaction.oncomplete = () => {
                    alert(t.importSuccess);
                    loadMemos();
                    loadMemosOnMap();
                    closeSettingsModal();
                    event.target.value = '';
                };

                transaction.onerror = () => {
                    alert(t.importFailed);
                    event.target.value = '';
                };
            } catch (error) {
                console.error('Import error:', error);
                alert(t.importFailed + ': ' + error.message);
                event.target.value = '';
            }
        }

        // Initialize
        (async () => {
            try {
                console.log('Initializing app...');
                await initDB();
                console.log('Database initialized:', db);
                initViewMap();
                console.log('View map initialized');
                loadMemos();
                loadMemosOnMap();
                applyLanguage(currentLanguage);
                updateFabBadge();
                console.log('App initialization complete');
            } catch (error) {
                console.error('Initialization error:', error);
                alert('ã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ / App initialization failed: ' + error.message);
            }
        })();
    </script>
</body>
</html>
